#!/usr/bin/env python3
"""
Test Complet du Syst√®me Multi-Agent MCP
=======================================

Ce script teste tous les composants du syst√®me :
1. Interface Desktop (tkinter simple)
2. Backend MCP avec orchestrateur
3. Agents (NLP, Vision, Audio, Security)
4. API FastAPI
5. Vault s√©curis√© avec chiffrement
6. Recherche intelligente

Usage:
    python test_complete_system.py
"""

import os
import sys
import time
import json
import threading
import subprocess
from pathlib import Path

# Configuration des chemins
BASE_DIR = Path(__file__).parent
TEST_FILES_DIR = BASE_DIR / "test_files"
VAULT_DIR = BASE_DIR / "vault"
LOGS_DIR = BASE_DIR / "logs"

# Cr√©er les r√©pertoires n√©cessaires
for dir_path in [TEST_FILES_DIR, VAULT_DIR, LOGS_DIR]:
    dir_path.mkdir(exist_ok=True)

class SystemTester:
    def __init__(self):
        self.test_results = []
        self.api_server_process = None
        
    def log_test(self, test_name, success, message=""):
        """Enregistre le r√©sultat d'un test"""
        result = {
            "test": test_name,
            "success": success,
            "message": message,
            "timestamp": time.strftime("%Y-%m-%d %H:%M:%S")
        }
        self.test_results.append(result)
        
        status = "‚úÖ PASS" if success else "‚ùå FAIL"
        print(f"{status} - {test_name}: {message}")
    
    def test_dependencies(self):
        """Test 1: V√©rifier les d√©pendances Python"""
        print("\nüîç Test 1: V√©rification des d√©pendances")
        
        required_modules = [
            "tkinter", "json", "sqlite3", "pathlib", "threading",
            "cryptography", "requests", "logging"
        ]
        
        missing_modules = []
        for module in required_modules:
            try:
                __import__(module)
                print(f"  ‚úì {module}")
            except ImportError:
                missing_modules.append(module)
                print(f"  ‚úó {module} - MANQUANT")
        
        if missing_modules:
            self.log_test("Dependencies", False, f"Modules manquants: {missing_modules}")
        else:
            self.log_test("Dependencies", True, "Tous les modules requis sont disponibles")
    
    def test_mcp_system(self):
        """Test 2: Syst√®me MCP simple"""
        print("\nü§ñ Test 2: Syst√®me MCP")
        
        try:
            # Import du syst√®me MCP
            sys.path.append(str(BASE_DIR))
            from simple_mcp_system import SimpleMCPSystem
            
            # Initialisation
            mcp = SimpleMCPSystem()
            
            # Test d'analyse d'un fichier
            test_file = TEST_FILES_DIR / "cours_histoire.txt"
            if test_file.exists():
                result = mcp.analyze_file(str(test_file))
                
                if result and result.get("success"):
                    self.log_test("MCP System", True, "Analyse de fichier r√©ussie")
                else:
                    self.log_test("MCP System", False, "√âchec de l'analyse")
            else:
                self.log_test("MCP System", False, "Fichier de test non trouv√©")
                
        except Exception as e:
            self.log_test("MCP System", False, f"Erreur: {str(e)}")
    
    def test_security_vault(self):
        """Test 3: Syst√®me de s√©curit√© et vault"""
        print("\nüîê Test 3: Syst√®me de s√©curit√©")
        
        try:
            sys.path.append(str(BASE_DIR))
            from simple_mcp_system import SimpleMCPSystem
            
            mcp = SimpleMCPSystem()
            
            # Test de chiffrement
            test_content = "Contenu secret pour test"
            password = "motdepasse123"
            
            encrypted = mcp.encrypt_content(test_content, password)
            if encrypted:
                decrypted = mcp.decrypt_content(encrypted, password)
                
                if decrypted == test_content:
                    self.log_test("Security Vault", True, "Chiffrement/d√©chiffrement r√©ussi")
                else:
                    self.log_test("Security Vault", False, "√âchec du d√©chiffrement")
            else:
                self.log_test("Security Vault", False, "√âchec du chiffrement")
                
        except Exception as e:
            self.log_test("Security Vault", False, f"Erreur: {str(e)}")
    
    def test_intelligent_search(self):
        """Test 4: Recherche intelligente"""
        print("\nüîç Test 4: Recherche intelligente")
        
        try:
            sys.path.append(str(BASE_DIR))
            from simple_mcp_system import SimpleMCPSystem
            
            mcp = SimpleMCPSystem()
            
            # Analyser tous les fichiers de test
            for file_path in TEST_FILES_DIR.glob("*.txt"):
                mcp.analyze_file(str(file_path))
            
            # Test de recherche
            search_results = mcp.search_files("carte vitale")
            
            if search_results:
                self.log_test("Intelligent Search", True, f"Trouv√© {len(search_results)} r√©sultats")
            else:
                self.log_test("Intelligent Search", False, "Aucun r√©sultat trouv√©")
                
        except Exception as e:
            self.log_test("Intelligent Search", False, f"Erreur: {str(e)}")
    
    def test_desktop_interface(self):
        """Test 5: Interface Desktop"""
        print("\nüñ•Ô∏è Test 5: Interface Desktop")
        
        try:
            import tkinter as tk
            from tkinter import ttk
            
            # Test de cr√©ation d'interface simple
            root = tk.Tk()
            root.title("Test Interface")
            root.geometry("300x200")
            
            # Cr√©er quelques widgets de test
            label = tk.Label(root, text="Test r√©ussi!")
            label.pack(pady=20)
            
            button = tk.Button(root, text="OK", command=root.destroy)
            button.pack(pady=10)
            
            # Fermer automatiquement apr√®s 1 seconde
            root.after(1000, root.destroy)
            root.mainloop()
            
            self.log_test("Desktop Interface", True, "Interface tkinter fonctionnelle")
            
        except Exception as e:
            self.log_test("Desktop Interface", False, f"Erreur tkinter: {str(e)}")
    
    def test_api_server(self):
        """Test 6: API FastAPI"""
        print("\nüåê Test 6: API Server")
        
        try:
            import requests
            
            # Tenter de d√©marrer l'API en arri√®re-plan
            try:
                import uvicorn
                import fastapi
                
                # D√©marrer le serveur API dans un thread s√©par√©
                def start_api():
                    try:
                        sys.path.append(str(BASE_DIR))
                        from api_server import app
                        uvicorn.run(app, host="127.0.0.1", port=8000, log_level="error")
                    except Exception as e:
                        print(f"Erreur API: {e}")
                
                api_thread = threading.Thread(target=start_api, daemon=True)
                api_thread.start()
                
                # Attendre que l'API d√©marre
                time.sleep(3)
                
                # Tester l'API
                response = requests.get("http://127.0.0.1:8000/health", timeout=5)
                
                if response.status_code == 200:
                    self.log_test("API Server", True, "API FastAPI fonctionnelle")
                else:
                    self.log_test("API Server", False, f"Code de statut: {response.status_code}")
                    
            except ImportError:
                self.log_test("API Server", False, "FastAPI ou uvicorn non install√©")
                
        except Exception as e:
            self.log_test("API Server", False, f"Erreur: {str(e)}")
    
    def test_complete_workflow(self):
        """Test 7: Workflow complet"""
        print("\nüîÑ Test 7: Workflow complet")
        
        try:
            sys.path.append(str(BASE_DIR))
            from simple_mcp_system import SimpleMCPSystem
            
            mcp = SimpleMCPSystem()
            
            # Sc√©nario complet
            print("  üìÅ Analyse du dossier de test...")
            results = mcp.analyze_directory(str(TEST_FILES_DIR))
            
            if results:
                sensitive_files = [f for f in results if f.get("sensitive")]
                normal_files = [f for f in results if not f.get("sensitive")]
                
                print(f"  üìä Fichiers analys√©s: {len(results)}")
                print(f"  üîê Fichiers sensibles: {len(sensitive_files)}")
                print(f"  üìÑ Fichiers normaux: {len(normal_files)}")
                
                # Test de recherche
                search_query = "cours histoire"
                search_results = mcp.search_files(search_query)
                print(f"  üîç Recherche '{search_query}': {len(search_results)} r√©sultats")
                
                self.log_test("Complete Workflow", True, 
                            f"Workflow complet: {len(results)} fichiers analys√©s")
            else:
                self.log_test("Complete Workflow", False, "Aucun r√©sultat d'analyse")
                
        except Exception as e:
            self.log_test("Complete Workflow", False, f"Erreur: {str(e)}")
    
    def generate_report(self):
        """G√©n√®re un rapport final"""
        print("\n" + "="*60)
        print("üìä RAPPORT DE TEST FINAL")
        print("="*60)
        
        total_tests = len(self.test_results)
        passed_tests = sum(1 for test in self.test_results if test["success"])
        failed_tests = total_tests - passed_tests
        
        print(f"Total des tests: {total_tests}")
        print(f"Tests r√©ussis: {passed_tests} ‚úÖ")
        print(f"Tests √©chou√©s: {failed_tests} ‚ùå")
        print(f"Taux de r√©ussite: {(passed_tests/total_tests)*100:.1f}%")
        
        if failed_tests > 0:
            print("\nüî¥ TESTS √âCHOU√âS:")
            for test in self.test_results:
                if not test["success"]:
                    print(f"  - {test['test']}: {test['message']}")
        
        print("\nüìã R√âSUM√â DES COMPOSANTS:")
        components = {
            "Dependencies": "D√©pendances Python",
            "MCP System": "Syst√®me multi-agents",
            "Security Vault": "Coffre-fort s√©curis√©",
            "Intelligent Search": "Recherche intelligente",
            "Desktop Interface": "Interface graphique",
            "API Server": "Serveur API",
            "Complete Workflow": "Workflow complet"
        }
        
        for test in self.test_results:
            status = "‚úÖ" if test["success"] else "‚ùå"
            component_name = components.get(test["test"], test["test"])
            print(f"  {status} {component_name}")
        
        # Sauvegarder le rapport
        report_file = LOGS_DIR / f"test_report_{time.strftime('%Y%m%d_%H%M%S')}.json"
        with open(report_file, 'w', encoding='utf-8') as f:
            json.dump(self.test_results, f, indent=2, ensure_ascii=False)
        
        print(f"\nüìÑ Rapport d√©taill√© sauvegard√©: {report_file}")
        
        return passed_tests, failed_tests
    
    def run_all_tests(self):
        """Ex√©cute tous les tests"""
        print("üöÄ D√âMARRAGE DES TESTS DU SYST√àME MCP")
        print("="*60)
        
        # Ex√©cuter tous les tests
        self.test_dependencies()
        self.test_mcp_system()
        self.test_security_vault()
        self.test_intelligent_search()
        self.test_desktop_interface()
        self.test_api_server()
        self.test_complete_workflow()
        
        # G√©n√©rer le rapport final
        passed, failed = self.generate_report()
        
        return failed == 0

def main():
    """Fonction principale"""
    print("üéØ Test Complet du Syst√®me Multi-Agent MCP")
    print("==========================================")
    
    tester = SystemTester()
    
    try:
        success = tester.run_all_tests()
        
        if success:
            print("\nüéâ TOUS LES TESTS SONT PASS√âS!")
            print("Le syst√®me est pr√™t pour la d√©monstration.")
        else:
            print("\n‚ö†Ô∏è  CERTAINS TESTS ONT √âCHOU√â")
            print("V√©rifiez les erreurs ci-dessus avant la d√©monstration.")
            
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è  Tests interrompus par l'utilisateur")
    except Exception as e:
        print(f"\nüí• Erreur critique: {e}")

if __name__ == "__main__":
    main()
