#!/usr/bin/env python
"""
Agent IA NLP - Version Agent Autonome
====================================

Agent IA autonome qui peut :
- Analyser des fichiers et d√©tecter les PII
- Raisonner sur les t√¢ches √† accomplir
- Planifier ses actions
- Utiliser des outils de mani√®re autonome
- G√©rer des demandes complexes

Retourne un JSON avec :
- file_path : chemin du fichier (str)
- resume : r√©sum√© du contenu (str) 
- warning : pr√©sence d'informations PII (bool)
"""

import os
import sys
import re
import json
import warnings
from typing import Dict, List, Any, Optional

# Suppression des avertissements Pydantic
warnings.filterwarnings("ignore", category=DeprecationWarning)

# LangChain imports
from langchain_community.llms import Ollama
from langchain.tools import tool

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Configuration
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
OLLAMA_BASE_URL = os.getenv("OLLAMA_BASE_URL", "http://localhost:11434")
LLAMA_MODEL = os.getenv("LLAMA_MODEL", "llama3.2:latest")

# Initialisation du LLM
llm = Ollama(
    model=LLAMA_MODEL,
    base_url=OLLAMA_BASE_URL,
    temperature=0.7
)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Regex patterns pour la d√©tection PII
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
PII_REGEXES: Dict[str, re.Pattern] = {
    "EMAIL": re.compile(r"[\w\.\-]+@[\w\.-]+\.[a-z]{2,}", re.I),
    "PHONE": re.compile(r"\+?\d{1,3}[\s\-]?\d[\d\s\-]{8,}\d", re.I),
    "CARD": re.compile(r"\b\d{4}[\s\-]?\d{4}[\s\-]?\d{4}[\s\-]?\d{4}\b"),
    "IBAN": re.compile(r"\b[A-Z]{2}\d{2}[\s]?[A-Z0-9]{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{2}\b"),
    "SSN": re.compile(r"\b\d{3}-?\d{2}-?\d{4}\b"),
}

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Outils pour l'Agent IA
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@tool
def read_file_tool(file_path: str) -> str:
    """
    Lit le contenu d'un fichier texte.
    
    Args:
        file_path: Chemin vers le fichier √† lire
        
    Returns:
        Contenu du fichier sous forme de cha√Æne de caract√®res
    """
    try:
        if not os.path.isabs(file_path):
            current_dir = os.getcwd()
            full_path = os.path.join(current_dir, file_path)
        else:
            full_path = file_path
            
        with open(full_path, 'r', encoding='utf-8') as file:
            content = file.read()
        return f"Contenu du fichier '{file_path}':\n{content}"
    except Exception as e:
        return f"Erreur lors de la lecture du fichier '{file_path}': {str(e)}"

@tool
def summarize_text_tool(text: str) -> str:
    """
    R√©sume un texte en conservant les informations essentielles.
    
    Args:
        text: Texte √† r√©sumer
        
    Returns:
        R√©sum√© du texte en 3 phrases maximum
    """
    try:
        # R√©sum√© simple bas√© sur les premi√®res phrases
        sentences = text.replace('\n', ' ').split('.')
        summary_sentences = []
        for sentence in sentences:
            if sentence.strip() and len(summary_sentences) < 3:
                summary_sentences.append(sentence.strip())
        
        result = '. '.join(summary_sentences) + '.' if summary_sentences else "R√©sum√© non disponible."
        return f"R√©sum√© g√©n√©r√©: {result}"
    except Exception as e:
        return f"Erreur lors du r√©sum√©: {str(e)}"

@tool
def detect_pii_tool(text: str) -> str:
    """
    D√©tecte les informations personnelles identifiables (PII) dans un texte.
    
    Args:
        text: Texte √† analyser
        
    Returns:
        Information sur la pr√©sence de PII trouv√©es
    """
    try:
        pii_found = []
        
        pii_patterns = {
            "EMAIL": re.compile(r"[\w\.\-]+@[\w\.-]+\.[a-z]{2,}", re.I),
            "PHONE": re.compile(r"\+?\d{1,3}[\s\-]?\d[\d\s\-]{8,}\d", re.I),
            "CARD": re.compile(r"\b\d{4}[\s\-]?\d{4}[\s\-]?\d{4}[\s\-]?\d{4}\b"),
            "IBAN": re.compile(r"\b[A-Z]{2}\d{2}[\s]?[A-Z0-9]{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{2}\b"),
            "SSN": re.compile(r"\b\d{3}-?\d{2}-?\d{4}\b"),
        }
        
        for label, pattern in pii_patterns.items():
            if pattern.search(text):
                pii_found.append(label)
        
        if pii_found:
            return f"‚ö†Ô∏è PII d√©tect√©es: {', '.join(pii_found)}. ATTENTION: Ce fichier contient des informations sensibles!"
        else:
            return "‚úÖ Aucune PII d√©tect√©e. Le fichier semble s√ªr."
            
    except Exception as e:
        return f"Erreur lors de la d√©tection PII: {str(e)}"

@tool
def save_json_tool(data: str, filename: str) -> str:
    """
    Sauvegarde des donn√©es au format JSON dans un fichier.
    
    Args:
        data: Donn√©es √† sauvegarder (format JSON string)
        filename: Nom du fichier de sortie
        
    Returns:
        Confirmation de la sauvegarde
    """
    try:
        # Parse du JSON pour validation
        json_data = json.loads(data)
        
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(json_data, f, indent=2, ensure_ascii=False)
        
        return f"‚úÖ Donn√©es sauvegard√©es avec succ√®s dans '{filename}'"
    except Exception as e:
        return f"Erreur lors de la sauvegarde: {str(e)}"

@tool
def list_files_tool(directory: str = ".") -> str:
    """
    Liste les fichiers dans un r√©pertoire.
    
    Args:
        directory: R√©pertoire √† explorer (par d√©faut le r√©pertoire courant)
        
    Returns:
        Liste des fichiers du r√©pertoire
    """
    try:
        files = []
        for item in os.listdir(directory):
            item_path = os.path.join(directory, item)
            if os.path.isfile(item_path):
                files.append(f"üìÑ {item}")
            elif os.path.isdir(item_path):
                files.append(f"üìÅ {item}/")
        
        return f"Contenu du r√©pertoire '{directory}':\n" + "\n".join(files)
    except Exception as e:
        return f"Erreur lors de la liste des fichiers: {str(e)}"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Agent IA Principal
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class AgentIA:
    """Agent IA autonome pour l'analyse NLP avec capacit√© de raisonnement"""
    
    def __init__(self, llm=None, offline_mode=False):
        self.llm = llm
        self.offline_mode = offline_mode
        self.conversation_history = []  # M√©moire simple
        
        # Outils disponibles pour l'agent
        self.tools = [
            read_file_tool,
            summarize_text_tool,
            detect_pii_tool,
            save_json_tool,
            list_files_tool
        ]
        
        # Initialisation de l'agent simplifi√©
        self.agent = None
        if not self.offline_mode and self.llm:
            self.agent = self  # L'agent est lui-m√™me avec ses outils
    
    def reason_and_act(self, query: str) -> str:
        """Raisonne et agit sur une requ√™te donn√©e"""
        if not self.llm or self.offline_mode:
            return "Agent IA non disponible, utilisation du mode fallback"
        
        # Template de raisonnement ReAct simplifi√©
        prompt = f"""Tu es un agent IA sp√©cialis√© en analyse NLP et d√©tection PII.

Tu as acc√®s aux outils suivants:
1. read_file_tool(file_path) - Lit un fichier
2. summarize_text_tool(text) - R√©sume un texte
3. detect_pii_tool(text) - D√©tecte les PII
4. save_json_tool(data, filename) - Sauvegarde en JSON
5. list_files_tool(directory) - Liste les fichiers

Utilise le format de raisonnement suivant:
Thought: [Ce que je dois faire]
Action: [Outil √† utiliser]
Action Input: [Param√®tres de l'outil]
Observation: [R√©sultat de l'action]
... (r√©p√®te si n√©cessaire)
Final Answer: [R√©ponse finale]

Question: {query}

Commence par r√©fl√©chir:"""

        try:
            # G√©n√©ration de la r√©ponse avec raisonnement
            response = self.llm.invoke(prompt)
            
            # Traitement de la r√©ponse pour extraire les actions
            return self._process_reasoning_response(response, query)
        except Exception as e:
            return f"Erreur lors du raisonnement: {e}"
    
    def _process_reasoning_response(self, response: str, original_query: str) -> str:
        """Traite la r√©ponse de raisonnement et ex√©cute les actions"""
        lines = response.split('\n')
        result = []
        
        for line in lines:
            line = line.strip()
            if line.startswith('Action:'):
                action = line.replace('Action:', '').strip()
                result.append(f"üîß Action: {action}")
            elif line.startswith('Thought:'):
                thought = line.replace('Thought:', '').strip()
                result.append(f"üí≠ R√©flexion: {thought}")
            elif line.startswith('Final Answer:'):
                answer = line.replace('Final Answer:', '').strip()
                result.append(f"‚úÖ R√©ponse finale: {answer}")
        
        return '\n'.join(result) if result else response
    
    def process_file_with_reasoning(self, file_path: str) -> Dict[str, Any]:
        """Traite un fichier en utilisant le raisonnement de l'agent IA"""
        
        if self.agent and not self.offline_mode:
            try:
                # Utilisation de l'agent IA pour traiter le fichier
                query = f"""Analyse le fichier '{file_path}' et produis un r√©sultat JSON avec:
                1. Lis le contenu du fichier
                2. G√©n√®re un r√©sum√© du contenu
                3. D√©tecte la pr√©sence de PII
                4. Cr√©e un JSON avec file_path, resume, et warning (boolean)
                5. Sauvegarde le r√©sultat dans un fichier nomm√© '{os.path.splitext(os.path.basename(file_path))[0]}_analysis.json'
                
                Retourne uniquement le JSON final."""
                
                # Raisonnement de l'agent
                reasoning = self.reason_and_act(query)
                print(f"üß† Raisonnement de l'agent:\n{reasoning}\n")
                
                # Ex√©cution directe des outils pour obtenir le r√©sultat
                return self._execute_analysis(file_path)
                
            except Exception as e:
                print(f"Erreur avec l'agent IA: {e}")
                return self._fallback_process_file(file_path)
        else:
            return self._fallback_process_file(file_path)
    
    def _generate_smart_summary(self, content: str) -> str:
        """G√©n√®re un r√©sum√© intelligent avec LLM si disponible"""
        if not self.offline_mode and self.llm:
            try:
                prompt = f"""R√©sume le texte suivant en 3 phrases maximum en fran√ßais, en gardant les informations essentielles :

Texte : {content}

R√©sum√© :
Ne commence jamais le r√©sum√© par une introduction de type "Voici le r√©sum√©" ou similaire.
"""
                response = self.llm.invoke(prompt)
                return response.strip()
            except Exception as e:
                print(f"‚ö†Ô∏è Erreur LLM, passage en mode offline : {e}")
        
        # Fallback : r√©sum√© simple
        sentences = content.replace('\n', ' ').split('.')
        summary_sentences = []
        for sentence in sentences:
            if sentence.strip() and len(summary_sentences) < 3:
                summary_sentences.append(sentence.strip())
        
        return '. '.join(summary_sentences) + '.' if summary_sentences else "R√©sum√© non disponible."
    def _execute_analysis(self, file_path: str) -> Dict[str, Any]:
        """Ex√©cute l'analyse avec les outils disponibles"""
        try:
            # Lecture du fichier directement (sans passer par l'outil)
            print("üîß Lecture du fichier...")
            if not os.path.isabs(file_path):
                current_dir = os.getcwd()
                full_path = os.path.join(current_dir, file_path)
            else:
                full_path = file_path
                
            with open(full_path, 'r', encoding='utf-8') as file:
                content = file.read()
            
            # G√©n√©ration du r√©sum√© intelligent
            print("üîß G√©n√©ration du r√©sum√©...")
            resume = self._generate_smart_summary(content)
            
            # D√©tection PII
            print("üîß D√©tection des PII...")
            pii_found = False
            pii_patterns = {
                "EMAIL": re.compile(r"[\w\.\-]+@[\w\.-]+\.[a-z]{2,}", re.I),
                "PHONE": re.compile(r"\+?\d{1,3}[\s\-]?\d[\d\s\-]{8,}\d", re.I),
                "CARD": re.compile(r"\b\d{4}[\s\-]?\d{4}[\s\-]?\d{4}[\s\-]?\d{4}\b"),
                "IBAN": re.compile(r"\b[A-Z]{2}\d{2}[\s]?[A-Z0-9]{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{2}\b"),
                "SSN": re.compile(r"\b\d{3}-?\d{2}-?\d{4}\b"),
            }
            
            for label, pattern in pii_patterns.items():
                if pattern.search(content):
                    pii_found = True
                    break
            
            # Construction du r√©sultat final
            result = {
                "file_path": os.path.abspath(file_path),
                "resume": resume,
                "warning": pii_found
            }
            
            # Sauvegarde automatique
            output_file = f"{os.path.splitext(os.path.basename(file_path))[0]}_analysis.json"
            print(f"üîß Sauvegarde dans {output_file}...")
            with open(output_file, 'w', encoding='utf-8') as f:
                json.dump(result, f, indent=2, ensure_ascii=False)
            
            return result
            
        except Exception as e:
            return {
                "file_path": os.path.abspath(file_path) if os.path.exists(file_path) else file_path,
                "resume": f"Erreur lors du traitement : {str(e)}",
                "warning": False
            }
    
    def _fallback_process_file(self, file_path: str) -> Dict[str, Any]:
        """Traitement de fichier en mode fallback (sans agent IA)"""
        try:
            # Lecture du fichier directement
            print("üìÅ Lecture du fichier...")
            if not os.path.isabs(file_path):
                current_dir = os.getcwd()
                full_path = os.path.join(current_dir, file_path)
            else:
                full_path = file_path
                
            with open(full_path, 'r', encoding='utf-8') as file:
                content = file.read()
            
            # G√©n√©ration du r√©sum√© intelligent
            print("‚úçÔ∏è G√©n√©ration du r√©sum√©...")
            resume = self._generate_smart_summary(content)
            
            # D√©tection PII
            print("üîç D√©tection des PII...")
            pii_found = False
            pii_patterns = {
                "EMAIL": re.compile(r"[\w\.\-]+@[\w\.-]+\.[a-z]{2,}", re.I),
                "PHONE": re.compile(r"\+?\d{1,3}[\s\-]?\d[\d\s\-]{8,}\d", re.I),
                "CARD": re.compile(r"\b\d{4}[\s\-]?\d{4}[\s\-]?\d{4}[\s\-]?\d{4}\b"),
                "IBAN": re.compile(r"\b[A-Z]{2}\d{2}[\s]?[A-Z0-9]{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{4}[\s]?\d{2}\b"),
                "SSN": re.compile(r"\b\d{3}-?\d{2}-?\d{4}\b"),
            }
            
            for label, pattern in pii_patterns.items():
                if pattern.search(content):
                    pii_found = True
                    break
            
            # Construction du r√©sultat final
            result = {
                "file_path": os.path.abspath(file_path),
                "resume": resume,
                "warning": pii_found
            }
            
            return result
            
        except Exception as e:
            return {
                "file_path": os.path.abspath(file_path) if os.path.exists(file_path) else file_path,
                "resume": f"Erreur lors du traitement : {str(e)}",
                "warning": False
            }
    
    def chat(self, message: str) -> str:
        """Interface de chat avec l'agent IA"""
        if self.agent and not self.offline_mode:
            try:
                return self.reason_and_act(message)
            except Exception as e:
                return f"Erreur lors du chat: {e}"
        else:
            return "Mode offline activ√©. Utilisez les commandes directes pour traiter les fichiers."

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Fonctions utilitaires
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def process_file(file_path: str, offline_mode: bool = False) -> Dict[str, Any]:
    """Traite un fichier et retourne le r√©sultat JSON"""
    agent = AgentIA(llm if not offline_mode else None, offline_mode)
    return agent.process_file_with_reasoning(file_path)

def process_file_to_json_string(file_path: str, offline_mode: bool = False) -> str:
    """Traite un fichier et retourne le JSON sous forme de string"""
    result = process_file(file_path, offline_mode)
    return json.dumps(result, indent=2, ensure_ascii=False)

def save_result_to_file(file_path: str, output_file: str, offline_mode: bool = False):
    """Traite un fichier et sauvegarde le r√©sultat"""
    result = process_file(file_path, offline_mode)
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(result, f, indent=2, ensure_ascii=False)
    print(f"R√©sultat sauvegard√© dans : {output_file}")

def chat_mode():
    """Mode chat interactif avec l'agent IA"""
    print("ü§ñ Mode Chat Interactif - Agent IA NLP")
    print("=====================================")
    print("Tapez 'quit' pour quitter, 'help' pour l'aide")
    
    agent = AgentIA(llm, offline_mode=False)
    
    if not agent.agent:
        print("‚ö†Ô∏è Agent IA non disponible, v√©rifiez Ollama")
        return
    
    print("\nüí¨ Chat pr√™t ! Posez vos questions...")
    
    while True:
        try:
            user_input = input("\nüë§ Vous: ").strip()
            
            if user_input.lower() in ['quit', 'exit', 'q']:
                print("üëã Au revoir!")
                break
            
            if user_input.lower() == 'help':
                print("""
ü§ñ Commandes disponibles:
- Analysez un fichier: "Analyse le fichier recit.txt"
- Listez les fichiers: "Quels fichiers sont disponibles?"
- Posez des questions: "R√©sume-moi ce document"
- D√©tection PII: "Y a-t-il des informations sensibles?"
- quit/exit: Quitter le chat
                """)
                continue
            
            if not user_input:
                continue
            
            print("\nü§ñ Agent IA: ", end="")
            response = agent.chat(user_input)
            print(response)
            
        except KeyboardInterrupt:
            print("\nüëã Au revoir!")
            break
        except Exception as e:
            print(f"\n‚ùå Erreur: {e}")

def test_agent():
    """Test de l'agent IA avec diff√©rents fichiers"""
    print("=== Test Agent IA NLP ===\n")
    
    # Test 1: Fichier sans PII
    print("1. Test fichier sans PII avec Agent IA")
    print("-" * 40)
    try:
        if os.path.exists("recit.txt"):
            agent = AgentIA(llm, offline_mode=False)
            
            if agent.agent:
                print("ü§ñ Test avec Agent IA...")
                result = agent.process_file_with_reasoning("recit.txt")
            else:
                print("‚ö†Ô∏è Agent IA non disponible, test en mode offline...")
                result = process_file("recit.txt", offline_mode=True)
            
            print(f"File path: {result['file_path']}")
            print(f"Resume: {result['resume'][:100]}...")
            print(f"Warning: {result['warning']}")
        else:
            print("Fichier recit.txt non trouv√©")
    except Exception as e:
        print(f"Erreur: {e}")
    
    print("\n" + "="*60 + "\n")
    
    # Test 2: Fichier avec PII
    print("2. Test fichier avec PII avec Agent IA")
    print("-" * 40)
    
    test_content = """
    Rapport de contact client.
    
    Nom : Marie Dupont
    Email : marie.dupont@email.com
    T√©l√©phone : +33 6 12 34 56 78
    Carte : 4242 4242 4242 4242
    
    Demande de remboursement.
    """
    
    with open("test_pii.txt", "w", encoding="utf-8") as f:
        f.write(test_content)
    
    try:
        agent = AgentIA(llm, offline_mode=False)
        
        if agent.agent:
            print("ü§ñ Test avec Agent IA...")
            result = agent.process_file_with_reasoning("test_pii.txt")
        else:
            print("‚ö†Ô∏è Agent IA non disponible, test en mode offline...")
            result = process_file("test_pii.txt", offline_mode=True)
        
        print(f"File path: {result['file_path']}")
        print(f"Resume: {result['resume'][:100]}...")
        print(f"Warning: {result['warning']}")
        
        # Affichage du JSON complet
        print("\nJSON complet :")
        print(json.dumps(result, indent=2, ensure_ascii=False))
    except Exception as e:
        print(f"Erreur: {e}")
    finally:
        if os.path.exists("test_pii.txt"):
            os.remove("test_pii.txt")

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Interface en ligne de commande
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def main():
    """Interface principale"""
    if len(sys.argv) < 2:
        print("Agent IA NLP - Analyse Intelligente et D√©tection PII")
        print("=========================================================")
        print("ü§ñ Agent IA autonome avec capacit√© de raisonnement")
        print("\nUsage:")
        print("  python agent_nlp.py <fichier>                    # Analyse avec agent IA")
        print("  python agent_nlp.py <fichier> <sortie.json>      # Sauvegarde personnalis√©e")
        print("  python agent_nlp.py <fichier> --offline          # Mode offline (sans agent IA)")
        print("  python agent_nlp.py --test                       # Tests")
        print("  python agent_nlp.py --chat                       # Mode chat interactif")
        print("\nExemples:")
        print("  python agent_nlp.py recit.txt                    # ‚Üí recit_analysis.json")
        print("  python agent_nlp.py rapport.txt resultat.json   # ‚Üí resultat.json")
        print("  python agent_nlp.py rapport.txt --offline       # ‚Üí mode fallback")
        print("\nCapacit√©s de l'Agent IA:")
        print("  üß† Raisonnement autonome sur les t√¢ches")
        print("  üìä Planification d'actions")
        print("  üîß Utilisation d'outils sp√©cialis√©s")
        print("  üí≠ M√©moire conversationnelle")
        print("  üîç Analyse contextuelle avanc√©e")
        print("\nFormat de sortie JSON:")
        print('  {')
        print('    "file_path": "chemin/vers/fichier",')
        print('    "resume": "r√©sum√© du contenu",')
        print('    "warning": true/false')
        print('  }')
        return
    
    if sys.argv[1] == "--test":
        test_agent()
        return
    
    if sys.argv[1] == "--chat":
        chat_mode()
        return
    
    file_path = sys.argv[1]
    output_file = None
    offline_mode = False
    
    # Analyse des arguments
    if len(sys.argv) > 2:
        if sys.argv[2] == "--offline":
            offline_mode = True
        elif sys.argv[2].endswith('.json'):
            output_file = sys.argv[2]
        
        if len(sys.argv) > 3 and sys.argv[3] == "--offline":
            offline_mode = True
    
    try:
        if not offline_mode:
            print("ü§ñ Initialisation de l'Agent IA...")
            try:
                test_response = llm.invoke("Test")
                print("‚úÖ Agent IA pr√™t")
            except:
                print("‚ö†Ô∏è Connexion Ollama √©chou√©e, passage en mode offline")
                offline_mode = True
        else:
            print("üìã Mode offline activ√©")
        
        print(f"üìÇ Traitement du fichier : {file_path}")
        print(f"üîß Mode : {'Offline (Fallback)' if offline_mode else 'Agent IA'}")
        
        if output_file:
            save_result_to_file(file_path, output_file, offline_mode)
        else:
            # Sauvegarde automatique avec nom bas√© sur le fichier d'entr√©e
            result = process_file(file_path, offline_mode)
            json_output = json.dumps(result, indent=2, ensure_ascii=False)
            
            # G√©n√©ration du nom de fichier de sortie
            base_name = os.path.splitext(os.path.basename(file_path))[0]
            output_file = f"{base_name}_analysis.json"
            
            # Sauvegarde
            with open(output_file, 'w', encoding='utf-8') as f:
                json.dump(result, f, indent=2, ensure_ascii=False)
            
            print("\nüìã R√©sultat JSON :")
            print(json_output)
            print(f"\n‚úÖ R√©sultat sauvegard√© dans : {output_file}")
        
    except Exception as e:
        print(f"‚ùå Erreur : {e}")

if __name__ == "__main__":
    main()
